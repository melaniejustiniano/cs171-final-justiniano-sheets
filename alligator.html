<!DOCTYPE html>
<html>
<head>
    <title></title>
</head>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/queue.v1.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script type="text/javascript" src="libs/jquery-1.11.0.min.js"></script>
<script src="libs/FileSaver.js"></script>

<div id="vis"></div>


<script>

jQuery.ajaxSettings.traditional = true; // necessary for list of buckets
var apiKey = 'AQZMTLHUCSWFXRMUJ';
var baseURL = 'http://developer.echonest.com/api/v4/';

function makeRequest(endPoint, options, success, error) {
    var url = baseURL + endPoint;

    var data = { 
        format:'jsonp', 
        api_key: apiKey,
    };
    $.extend(data, options);

    $.ajax({
        dataType: "jsonp",
        cache: true,
        type: 'GET',
        url: url,
        data: data,
        success: success,
        error: error
    });
}

function getGenres() {
    console.log("getGenres() ...")

    var genres = [];

    function callback(data, textStatus, jqXHR) {
        genres = genres.concat(data.response.genres);

        if (genres.length < data.response.total) {
            var options = { results: 100, start: genres.length };
            makeRequest('genre/list', options, callback, error);
        }
        else {
            console.log("getGenres() COMPLETE");
            return genres;
        }
    }

    function error(jqXHR, textStatus, errorThrown) {
        alert("Error retrieving data. Please reload page.")
    }

    var options = { results: 100 };
    makeRequest('genre/list', options, callback, error);
}

function getArtists(genres, numArtists) {
    if (!numArtists)
        numArtists = 100;
    console.log("getArtists() ...");

    // Convert to Objects
    genres = genres.map(function(g) {
        return { name: g, artists: [] };
    })

    // Fetch Artists by Genre
    var genresCollected = 0;
    genres.map(function(g) {
        function callback(data, textStatus, jqXHR) {
            g.artists = g.artists.concat(data.response.artists);

            if (g.artists.length < numArtists) {
                var remaining = numArtists - g.artists.length;
                var options = { results: (remaining < 100) ? remaining : 100, genre: g.name, bucket: ['artist_location', 'years_active'], sort: 'familiarity-desc', start: g.artists.length };
                makeRequest('artist/search', options, callback, error);              
            }
            else {
                console.log("getArtists() COMPLETE");
                if (++genresCollected == genres.length) {
                    // Sort Artists by Year
                    g.artists.sort(function(a, b) {
                        if (a.years_active[0].start < b.years_active[0].start) return -1;
                        else if (a.years_active[0].start > b.years_active[0].start) return 1;
                        else return 0;
                    })
                    artistsFetched();
                }
            }
        }

        function error(jqXHR, textStatus, errorThrown) {
            alert("Error retrieving artists for " + genre.name + ". Please reload page.")
        }

        var remaining = numArtists - g.artists.length;
        var options = { results: (remaining < 100) ? remaining : 100, genre: g.name, bucket: ['artist_location', 'years_active'], sort: 'familiarity-desc' };
        makeRequest('artist/search', options, callback, error);
    });

    function artistsFetched() {
        saveToFile(genres, "artistsByGenre.json");
    }
}

var saveToFile = function(object, filename){
    var blob, blobText;
    blobText = [JSON.stringify(object)];
    blob = new Blob(blobText, {
        type: "text/plain;charset=utf-8"
    });
    saveAs(blob, filename);
}

getArtists(['grunge']);

</script>


</body>
</html>